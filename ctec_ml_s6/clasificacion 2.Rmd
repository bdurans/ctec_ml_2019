---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tarea 6.
## Metodos supervisados 2

Librerias
```{r}
library(caTools)
library(rpart)
library(dplyr)
library(visdat)
library(tidyr)
library(GGally)
library(rpart.plot)
library(randomForest)
#..........Librerias de los modelos
```

### Análisis del Problema

Construya el análisis del problema


Los datos se obtienen mediante el parte oficial de tránsito que realiza la Dirección General de Policía de Tránsito al presentarse un accidente, los cuales ingresan a la base de datos de dos formas (hand held y papel). Debido a que parte de la labor principal de la Institución es salvar vidas, y por los recursos limitados que existen, se trabaja solo con accidentes con heridos y/o fallecidos; y no se trabaja con accidentes que presentan solo daños materiales. 


Fuente del dataset:
http://datosabiertos.csv.go.cr/dashboards/19683/accidentes/

### Análisis exploratorio

Cargue el archivo nombre.csv en una variable

```{r}
personas_accidentadas_original <- read.csv("personas_accidentadas.csv", encoding = "UTF-8", na.strings = c("Desconocido", "Desconocida"), stringsAsFactors = TRUE)
```

Desarolle el Entendimiento de los Datos

```{r}
head(personas_accidentadas_original)
```

Como se mencionó en el análisis del problema, los datos presentan información sobre accidentes de tránsito occuridos en distintos sectores del país. Además podemos observar las siguientes carácterísticas:

Existen 15 carácterísticas en el conjunto de datos, las cuales son:

A_Persona: parece ser un tipo de columna que se originó en alguna consulta, no parece ser relevante para el análisis.
Rol: El rol de la persona en el accidente. Niveles: Pasajero moto, Motociclista, Conductor, Peatón, Dueño de propiedad, Pasajero carro, Ciclista, Pasajero bus o microbús, Pasajero bicicleta, Otro.
Tipo.de.lesión: Herido grave, Herido leve, Ileso o Muerte.
Edad: Edad de la persona involucrada en el accidente.
Edad.quinquenal: Edad de la persona involucrada en el accidente en quinquenios (rango de 5 años), no parece ser muy relevanta ya qe se cuenta con la edad especifica de dicha persona.
Sexo: Hombre o Mujer
Año: Año en el que ocurrió el accidente: 2013 2014 2015 2016 2017 
Mes: Mes en el que ocurrió el accidente
Día: Día de la semana en el cual ocurrió el accidente
Provincia: Provincia en la cual occurrió el accidente
Cantón: Cantón en la cual occurrió el accidente
Distrito: Distrito en la cual occurrió el accidente
Día.1: tiene la misma información que la columna "Día" en un formato diferente, por ejemplo "1.Domingo" en lugar de "Domingo"
Mes.1: tiene la misma información que la columna "Mes" en un formato diferente, por ejemplo "A. Enero" en lugar de "Enero"
Edad.quinquenal.1: tiene la misma información que la columna "Edad quinquenal" en un formato diferente, por ejemplo "15 A 19" en lugar de "De 15 a 19"

Basándose en la descripción de variables anterior, se puede ver que la columna "A_Persona", "Día.1", "Mes.1" y "Edad.quinquenal.1" pueden ser removidas del dataframe, ya que no aportan un valor al análisis.

```{r}
personas_accidentadas <- personas_accidentadas_original %>%
  select(-c("A_Persona", "Edad.quinquenal", "Dia.1", "Mes.1", "Edad.quinquenal.1"))
personas_accidentadas
```

#### Análisis de valores faltantes

```{r, cache=TRUE}
vis_dat(personas_accidentadas, warn_large_data=FALSE)
```

Porcentanje de filas con datos nulos

```{r}
(sum(is.na(personas_accidentadas$Edad)) / nrow(personas_accidentadas)) * 100
```

Los datos nulos se encuentan en las columnas Edad y Edad.quinquenal, dado que contamos con 158,399 entradas y las filas que poseen esos valores nulos representan un %5,18 (8216 entradas) del total de los datos, podemos decir que es seguro removerlos del dataset ya que no tendría un impacto significativo en los modelos.

```{r, cache=TRUE}
personas_accidentadas <- personas_accidentadas %>% 
  drop_na()
vis_dat(personas_accidentadas, warn_large_data=FALSE)
```

#### Correlaciones entre las variables


Total de individuos por rol según el tipo de lesión

```{r}
accidentes_por_rol <- personas_accidentadas %>%
  group_by(Rol, TipoLesion) %>%
  summarize(total = n())
            
ggplot(accidentes_por_rol) +
  geom_bar(aes(x = Rol, weight = total, fill=TipoLesion)) +
  labs(x="Tipo de lesión", y="Total de individuos por rol") +
  coord_flip()

```

Total de individuos por provincia según el tipo de lesión

```{r}
accidentes_por_rol <- personas_accidentadas %>%
  group_by(Provincia, TipoLesion) %>%
  summarize(total = n())
            
ggplot(accidentes_por_rol) +
  geom_bar(aes(x = Provincia, weight = total, fill=TipoLesion)) +
  labs(x="Tipo de lesión", y="Total de individuos por Provincia") +
  coord_flip()

```

### Modelado

Realice al menos 5 modelos de los observados en clase


#### Árboles de decisión

Datos de entrenamiento y pruebas

```{r}
set.seed(1)
# Primero se crea un vector de valores lógicos basándose en el data.frame original
splt <- sample.split(personas_accidentadas$TipoLesion, SplitRatio = 0.7)
# Luego se utiliza el set creado anteriormente para dividir la información en un conjunto de datos de entrenamiento y prueba
datos_entrenamiento <- personas_accidentadas[splt,] 
datos_prueba <- personas_accidentadas[!splt,]
```

##### Creación del modelo

```{r, cache=TRUE}
modelo_arbol_decision <- rpart(TipoLesion ~ Rol, data = datos_entrenamiento, method =  'class')
```

##### Evaluación del modelo

Predicciones:

```{r}
predicciones_arbol_decision <- predict(modelo_arbol_decision, newdata = datos_prueba, type = 'class')
```


#### Bosques aleatorios

##### Creación del modelo

```{r}
set.seed(1)
modelo_bosque_aleatorio <- randomForest(TipoLesion ~ Rol, data = datos_entrenamiento)
```

##### Evaluación del modelo

Predicciones:

```{r}
predicciones_bosque_aleatorio <- predict(modelo_bosque_aleatorio, newdata = datos_prueba, type = 'class')
```

#### Regresión Logística

##### Creación del modelo

```{r}
modelo_regresion_logistica <- glm(TipoLesion ~ Rol, data = datos_entrenamiento, family = binomial)
```

##### Evaluación del modelo

Predicciones:

```{r}
predicciones_regresion_logistica <- predict(modelo_regresion_logistica, newdata = datos_prueba, type = 'response')
```

#### SVM

##### Creación del modelo

```{r, cache=True}
modelo_svm <- svm(TipoLesion ~ Rol, data = datos_entrenamiento, kernel='linear',cross=2, scale=FALSE)
```

##### Evaluación del modelo

Predicciones:

```{r, cache=True}
prediccion_svm <- predict(modelo_svm , newdata = datos_prueba)
```

#### Redes Neuronales

##### Creación del modelo

```{r}
m <- model.matrix( 
   ~TipoLesion + Rol,
  data = datos_entrenamiento 
)

modelo_red_neuronal <- neuralnet(TipoLesion ~ Rol, data = m, hidden=4, rep=1, linear.output=T, stepmax=1e6)
```

##### Evaluación del modelo

Predicciones:

```{r}
prediccion_svm <- predict(modelo_svm , newdata = datos_prueba)
```

### Conclusiones

Desarolle al menos 5 conclusiones sobre las clasificaciones de los modelos



